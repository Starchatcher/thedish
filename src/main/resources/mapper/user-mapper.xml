<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="userMapper">
    <insert id="insertUser" parameterType="User">
        INSERT INTO users (
            user_id, password, name, birthdate, gender, email, created_at, status
        ) VALUES (
            #{userId}, #{password}, #{name}, #{birthdate}, #{gender}, #{email}, SYSDATE, 'ACTIVE'
        )
    </insert>
    
    <select id="selectUserById" parameterType="string" resultType="User">
        SELECT 
            id,
            user_id as userId, 
            password, 
            name, 
            birthdate, 
            gender, 
            email, 
            created_at as createdAt, 
            updated_at as updatedAt,
            status
        FROM users
        WHERE user_id = #{userId}
    </select>
    
    <update id="updatePassword" parameterType="User">
        UPDATE users
        SET password = #{password}, updated_at = SYSDATE
        WHERE user_id = #{userId}
    </update>
    
    <update id="updateUserStatus" parameterType="User">
        UPDATE users
        SET status = #{status}, updated_at = SYSDATE
        WHERE user_id = #{userId}
    </update>
    
    <insert id="saveVerificationCode" parameterType="VerificationCode">
        MERGE INTO verification_codes
        USING DUAL ON (email = #{email})
        WHEN MATCHED THEN
            UPDATE SET code = #{code}, created_at = SYSDATE
        WHEN NOT MATCHED THEN
            INSERT (id, email, code, created_at)
            VALUES (verification_seq.NEXTVAL, #{email}, #{code}, SYSDATE)
    </insert>
    
    <select id="getVerificationCode" parameterType="string" resultType="string">
        SELECT code
        FROM verification_codes
        WHERE email = #{email}
        AND created_at > SYSDATE - INTERVAL '10' MINUTE
        ORDER BY created_at DESC
        FETCH FIRST 1 ROW ONLY
    </select>
</mapper>